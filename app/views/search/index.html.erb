<% content_for :show_tabs, true %>

<div class="search-container" data-controller="share rename">
  <!-- Search Input Section -->
  <div class="search-input-section">
    <%= form_with url: search_path, method: :get, class: "search-form", id: "search-form", data: { controller: "search-filters" } do %>
      <div class="search-input-wrapper">
        <svg class="search-input-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input type="text"
               name="q"
               value="<%= @query %>"
               placeholder="Search projects, files, samples..."
               class="search-input"
               autocomplete="off"
               data-search-filters-target="searchInput"
               data-action="input->search-filters#searchWithDebounce keydown->search-filters#submitOnEnter"
               <%= 'autofocus' if @query.present? %>>
        <% if @query.present? %>
          <%= link_to search_path, class: "search-clear-btn" do %>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          <% end %>
        <% end %>
      </div>

      <!-- Filters Row -->
      <div class="search-filters">
        <!-- Sort By -->
        <div class="filter-group filter-group-sort">
          <label class="filter-label">Sort by</label>
          <select name="sort" class="filter-select" data-action="change->search-filters#submit">
            <option value="" <%= 'selected' if @sort.blank? %>>------</option>
            <option value="recent" <%= 'selected' if @sort == 'recent' %>>Recent</option>
            <option value="oldest" <%= 'selected' if @sort == 'oldest' %>>Oldest</option>
            <option value="a-z" <%= 'selected' if @sort == 'a-z' %>>A-Z</option>
            <option value="z-a" <%= 'selected' if @sort == 'z-a' %>>Z-A</option>
          </select>
        </div>

        <!-- Date Range -->
        <div class="filter-row filter-row-dates">
          <div class="filter-group">
            <label class="filter-label">From</label>
            <input type="date" name="date_from" value="<%= @date_from %>" class="filter-date" data-action="change->search-filters#submit">
          </div>
          <div class="filter-group">
            <label class="filter-label">To</label>
            <input type="date" name="date_to" value="<%= @date_to %>" class="filter-date" data-action="change->search-filters#submit">
          </div>
        </div>

        <!-- BPM with Exact/Range toggle -->
        <div class="filter-group filter-group-bpm">
          <label class="filter-label">BPM</label>
          <div class="bpm-controls">
            <select name="bpm_mode" class="filter-select bpm-mode-select" data-action="change->search-filters#toggleBpmMode change->search-filters#submit" data-search-filters-target="bpmMode">
              <option value="range" <%= 'selected' if @bpm_mode == 'range' %>>Range</option>
              <option value="exact" <%= 'selected' if @bpm_mode == 'exact' %>>Exact</option>
            </select>

            <!-- Exact BPM input -->
            <div class="bpm-exact-input <%= 'hidden' unless @bpm_mode == 'exact' %>" data-search-filters-target="bpmExact">
              <input type="number" name="bpm_exact" value="<%= @bpm_exact %>" class="filter-number" placeholder="80" min="40" max="300" data-action="change->search-filters#submit keydown->search-filters#submitOnEnter" data-search-filters-target="bpmExactInput">
            </div>

            <!-- Range BPM inputs -->
            <div class="bpm-range-inputs <%= 'hidden' if @bpm_mode == 'exact' %>" data-search-filters-target="bpmRange">
              <input type="number" name="bpm_min" value="<%= @bpm_min %>" class="filter-number" placeholder="70" min="40" max="300" data-action="change->search-filters#submit keydown->search-filters#submitOnEnter" data-search-filters-target="bpmMinInput">
              <span class="bpm-separator">-</span>
              <input type="number" name="bpm_max" value="<%= @bpm_max %>" class="filter-number" placeholder="140" min="40" max="300" data-action="change->search-filters#submit keydown->search-filters#submitOnEnter" data-search-filters-target="bpmMaxInput">
            </div>
          </div>
        </div>

        <!-- Key & Clear All -->
        <div class="filter-row filter-row-key">
          <!-- Musical Key -->
          <div class="filter-group">
            <label class="filter-label">Key</label>
            <select name="key" class="filter-select" data-action="change->search-filters#submit">
              <option value="">Any key</option>
              <optgroup label="Major">
                <option value="C" <%= 'selected' if @key == 'C' %>>C Major</option>
                <option value="C#" <%= 'selected' if @key == 'C#' %>>C# Major</option>
                <option value="D" <%= 'selected' if @key == 'D' %>>D Major</option>
                <option value="Eb" <%= 'selected' if @key == 'Eb' %>>Eb Major</option>
                <option value="E" <%= 'selected' if @key == 'E' %>>E Major</option>
                <option value="F" <%= 'selected' if @key == 'F' %>>F Major</option>
                <option value="F#" <%= 'selected' if @key == 'F#' %>>F# Major</option>
                <option value="G" <%= 'selected' if @key == 'G' %>>G Major</option>
                <option value="Ab" <%= 'selected' if @key == 'Ab' %>>Ab Major</option>
                <option value="A" <%= 'selected' if @key == 'A' %>>A Major</option>
                <option value="Bb" <%= 'selected' if @key == 'Bb' %>>Bb Major</option>
                <option value="B" <%= 'selected' if @key == 'B' %>>B Major</option>
              </optgroup>
              <optgroup label="Minor">
                <option value="Cm" <%= 'selected' if @key == 'Cm' %>>C Minor</option>
                <option value="C#m" <%= 'selected' if @key == 'C#m' %>>C# Minor</option>
                <option value="Dm" <%= 'selected' if @key == 'Dm' %>>D Minor</option>
                <option value="Ebm" <%= 'selected' if @key == 'Ebm' %>>Eb Minor</option>
                <option value="Em" <%= 'selected' if @key == 'Em' %>>E Minor</option>
                <option value="Fm" <%= 'selected' if @key == 'Fm' %>>F Minor</option>
                <option value="F#m" <%= 'selected' if @key == 'F#m' %>>F# Minor</option>
                <option value="Gm" <%= 'selected' if @key == 'Gm' %>>G Minor</option>
                <option value="Abm" <%= 'selected' if @key == 'Abm' %>>Ab Minor</option>
                <option value="Am" <%= 'selected' if @key == 'Am' %>>A Minor</option>
                <option value="Bbm" <%= 'selected' if @key == 'Bbm' %>>Bb Minor</option>
                <option value="Bm" <%= 'selected' if @key == 'Bm' %>>B Minor</option>
              </optgroup>
            </select>
          </div>

          <%= link_to "Clear all", search_path, class: "filter-clear-btn" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Results Section -->
  <div class="search-results-section">
    <% daw_count = @daw_files.count %>
    <% audio_count = @other_projects.count + @audio_files.count %>
    <% total_results = daw_count + audio_count %>

    <% if @has_filters %>
      <div class="search-results-header">
        <span class="results-count"><%= total_results %> result<%= total_results == 1 ? '' : 's' %></span>
        <% if @query.present? %>
          <span class="results-query">for "<%= @query %>"</span>
        <% end %>
      </div>

      <% if total_results > 0 %>
        <!-- DAW Results (.als, .logicx, .flp, .ptx files - excluding Backup folders) -->
        <% if daw_count > 0 %>
          <div class="results-group">
            <h3 class="results-group-title">DAW (<%= daw_count %>)</h3>
            <div class="projects-grid">
              <% @daw_files.each do |file| %>
                <div class="project-card-wrapper">
                  <%= link_to asset_path(file.root_asset, folder_id: file.parent_id), class: "project-card" do %>
                    <div class="project-icon">
                      <%= image_tag asset_icon_for(file), class: "icon-image" %>
                    </div>
                    <p><%= file.original_filename %></p>
                  <% end %>

                  <%# Three-dot menu %>
                  <div class="card-menu" data-controller="dropdown">
                    <button class="menu-trigger" data-action="click->dropdown#toggle">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <circle cx="3" cy="8" r="1.5"/>
                        <circle cx="8" cy="8" r="1.5"/>
                        <circle cx="13" cy="8" r="1.5"/>
                      </svg>
                    </button>
                    <div class="menu-dropdown" data-dropdown-target="menu">
                      <div class="menu-item-with-submenu">
                        <button class="menu-item menu-item-parent">
                          <span>Share</span>
                          <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                            <path d="M4.5 2L8.5 6L4.5 10" stroke="currentColor" stroke-width="1.5" fill="none"/>
                          </svg>
                        </button>
                        <div class="submenu">
                          <div class="submenu-inner">
                            <button class="menu-item" data-action="click->share#open" data-asset-id="<%= file.id %>">
                              Create a link
                            </button>
                          </div>
                        </div>
                      </div>

                      <% if file.file.attached? %>
                        <%= link_to "Download", download_file_asset_path(file.root_asset, file_id: file.id), class: "menu-item" %>
                      <% end %>

                      <button class="menu-item" data-action="click->rename#open" data-asset-id="<%= file.root_asset.id %>" data-file-id="<%= file.id %>" data-asset-title="<%= file.original_filename %>">
                        Rename
                      </button>

                      <!-- Share with submenu -->
                      <%= render 'shared/share_with_submenu', asset: file %>

                      <div class="menu-divider"></div>

                      <%= link_to "Delete", destroy_file_asset_path(file.root_asset, file_id: file.id),
                          data: { turbo_method: :delete, turbo_confirm: "Delete '#{file.original_filename}'?" },
                          class: "menu-item menu-item-danger" %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Audio & Files Results (folders, audio, and other files) -->
        <% if audio_count > 0 %>
          <div class="results-group">
            <h3 class="results-group-title">Audio & Files (<%= audio_count %>)</h3>
            <div class="projects-grid">
              <%# Root-level assets (folders, standalone audio uploads) %>
              <% @other_projects.each do |asset| %>
                <div class="project-card-wrapper">
                  <% if asset.folder? %>
                    <%= link_to asset_path(asset), class: "project-card" do %>
                      <div class="project-icon">
                        <%= image_tag asset_icon_for(asset), class: "icon-image" %>
                      </div>
                      <p><%= asset.title %></p>
                    <% end %>
                  <% elsif asset.file.attached? %>
                    <% ext = File.extname(asset.file.filename.to_s).downcase.delete(".") %>
                    <% if %w[wav mp3 aif aiff flac m4a].include?(ext) %>
                      <div class="project-card"
                           data-audio-url="<%= url_for(asset.file) %>"
                           data-audio-title="<%= asset.title %>">
                        <div class="project-icon">
                          <%= image_tag asset_icon_for(asset), class: "icon-image" %>
                        </div>
                        <p><%= asset.title %><%= File.extname(asset.file.filename.to_s) %></p>
                      </div>
                    <% else %>
                      <%= link_to asset_path(asset), class: "project-card" do %>
                        <div class="project-icon">
                          <%= image_tag asset_icon_for(asset), class: "icon-image" %>
                        </div>
                        <p><%= asset.title %></p>
                      <% end %>
                    <% end %>
                  <% else %>
                    <%= link_to asset_path(asset), class: "project-card" do %>
                      <div class="project-icon">
                        <%= image_tag asset_icon_for(asset), class: "icon-image" %>
                      </div>
                      <p><%= asset.title %></p>
                    <% end %>
                  <% end %>

                  <%# Three-dot menu for root-level assets %>
                  <div class="card-menu" data-controller="dropdown">
                    <button class="menu-trigger" data-action="click->dropdown#toggle">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <circle cx="3" cy="8" r="1.5"/>
                        <circle cx="8" cy="8" r="1.5"/>
                        <circle cx="13" cy="8" r="1.5"/>
                      </svg>
                    </button>
                    <div class="menu-dropdown" data-dropdown-target="menu">
                      <div class="menu-item-with-submenu">
                        <button class="menu-item menu-item-parent">
                          <span>Share</span>
                          <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                            <path d="M4.5 2L8.5 6L4.5 10" stroke="currentColor" stroke-width="1.5" fill="none"/>
                          </svg>
                        </button>
                        <div class="submenu">
                          <div class="submenu-inner">
                            <button class="menu-item" data-action="click->share#open" data-asset-id="<%= asset.id %>">
                              Create a link
                            </button>
                          </div>
                        </div>
                      </div>

                      <%= link_to "Download", download_asset_path(asset), class: "menu-item" %>

                      <button class="menu-item" data-action="click->rename#open" data-asset-id="<%= asset.id %>" data-asset-title="<%= asset.title %>">
                        Rename
                      </button>

                      <!-- Share with submenu -->
                      <%= render 'shared/share_with_submenu', asset: asset %>

                      <div class="menu-divider"></div>

                      <%= link_to "Delete", asset_path(asset),
                          data: { turbo_method: :delete, turbo_confirm: "Delete '#{asset.title}'? This cannot be undone." },
                          class: "menu-item menu-item-danger" %>
                    </div>
                  </div>
                </div>
              <% end %>
              <%# Child assets (audio files and folders within extracted ZIPs) %>
              <% @audio_files.each do |file| %>
                <div class="project-card-wrapper">
                  <% if file.is_directory %>
                    <%= link_to asset_path(file.root_asset, folder_id: file.id), class: "project-card" do %>
                      <div class="project-icon">
                        <%= image_tag asset_icon_for(file), class: "icon-image" %>
                      </div>
                      <p><%= file.original_filename %></p>
                    <% end %>
                  <% elsif %w[wav mp3 aif aiff flac m4a].include?(file.extension) && file.file.attached? %>
                    <div class="project-card"
                         data-audio-url="<%= url_for(file.file) %>"
                         data-audio-title="<%= file.original_filename %>">
                      <div class="project-icon">
                        <%= image_tag asset_icon_for(file), class: "icon-image" %>
                      </div>
                      <p><%= file.original_filename %></p>
                    </div>
                  <% else %>
                    <%= link_to asset_path(file.root_asset, folder_id: file.parent_id), class: "project-card" do %>
                      <div class="project-icon">
                        <%= image_tag asset_icon_for(file), class: "icon-image" %>
                      </div>
                      <p><%= file.original_filename %></p>
                    <% end %>
                  <% end %>

                  <%# Three-dot menu for child assets %>
                  <div class="card-menu" data-controller="dropdown">
                    <button class="menu-trigger" data-action="click->dropdown#toggle">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <circle cx="3" cy="8" r="1.5"/>
                        <circle cx="8" cy="8" r="1.5"/>
                        <circle cx="13" cy="8" r="1.5"/>
                      </svg>
                    </button>
                    <div class="menu-dropdown" data-dropdown-target="menu">
                      <div class="menu-item-with-submenu">
                        <button class="menu-item menu-item-parent">
                          <span>Share</span>
                          <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                            <path d="M4.5 2L8.5 6L4.5 10" stroke="currentColor" stroke-width="1.5" fill="none"/>
                          </svg>
                        </button>
                        <div class="submenu">
                          <div class="submenu-inner">
                            <button class="menu-item" data-action="click->share#open" data-asset-id="<%= file.id %>">
                              Create a link
                            </button>
                          </div>
                        </div>
                      </div>

                      <% if file.is_directory %>
                        <%= link_to "Download", download_folder_asset_path(file.root_asset, folder_id: file.id), class: "menu-item" %>
                      <% elsif file.file.attached? %>
                        <%= link_to "Download", download_file_asset_path(file.root_asset, file_id: file.id), class: "menu-item" %>
                      <% end %>

                      <button class="menu-item" data-action="click->rename#open" data-asset-id="<%= file.root_asset.id %>" data-file-id="<%= file.id %>" data-asset-title="<%= file.original_filename %>">
                        Rename
                      </button>

                      <!-- Share with submenu -->
                      <%= render 'shared/share_with_submenu', asset: file %>

                      <div class="menu-divider"></div>

                      <%= link_to "Delete", destroy_file_asset_path(file.root_asset, file_id: file.id),
                          data: { turbo_method: :delete, turbo_confirm: "Delete '#{file.original_filename}'?#{file.is_directory? ? ' This will delete all contents inside.' : ''}" },
                          class: "menu-item menu-item-danger" %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="search-no-results-box">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <p>No results found</p>
          <span>Try adjusting your search or filters</span>
        </div>
      <% end %>
    <% else %>
      <!-- Empty state - no search yet -->
      <div class="search-empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <p>Search your library</p>
        <span>Find projects, samples, and files by name, BPM, key, or date</span>
      </div>
    <% end %>
  </div>

<!-- Rename Modal -->
<div id="rename-modal" class="modal-overlay" data-controller="rename">
  <div class="modal-content">
    <h3>Rename</h3>
    <form id="rename-form" data-action="submit->rename#submit">
      <input type="hidden" id="rename-asset-id" data-rename-target="assetId">
      <input type="hidden" id="rename-file-id" data-rename-target="fileId">
      <input type="text" name="title" placeholder="New name" class="folder-name-input" id="rename-input" data-rename-target="input" required>
      <div class="modal-actions">
        <button type="button" class="cancel-btn" data-action="click->rename#close">Cancel</button>
        <button type="submit" class="save-btn">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Share Link Modal -->
<div id="share-modal" class="modal-overlay" data-share-target="modal" data-action="click->share#clickOutside">
  <div class="modal-content">
    <h3>Share Link</h3>

    <!-- Create Form -->
    <div data-share-target="createForm">
      <div class="share-form-field">
        <label>Password (optional)</label>
        <input type="password" placeholder="Leave blank for no password" class="folder-name-input" data-share-target="passwordField">
      </div>

      <div class="share-form-field">
        <label>Expires (optional)</label>
        <select class="folder-name-input" data-share-target="expiresField">
          <option value="">Never</option>
          <option value="1_hour">1 hour</option>
          <option value="24_hours">24 hours</option>
          <option value="7_days">7 days</option>
          <option value="30_days">30 days</option>
        </select>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" data-action="click->share#close">Cancel</button>
        <button type="button" class="save-btn" data-action="click->share#createLink">Create Link</button>
      </div>
    </div>

    <!-- Link Display (shown after creation) -->
    <div data-share-target="linkDisplay" class="hidden">
      <div class="share-link-display">
        <input type="text" readonly class="share-link-input" data-share-target="url">
        <button type="button" class="copy-btn" data-action="click->share#copyLink" data-share-target="copyBtn">Copy</button>
      </div>
      <div class="modal-actions">
        <button type="button" class="save-btn" data-action="click->share#close" style="width: 100%;">Done</button>
      </div>
    </div>
  </div>
</div>

</div> <!-- Close search-container with share/rename controllers -->

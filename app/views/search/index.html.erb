<% content_for :page_title, "SEARCH" %>

<div class="search-container">
  <!-- Search Input Section -->
  <div class="search-input-section">
    <%= form_with url: search_path, method: :get, class: "search-form", id: "search-form", data: { controller: "search-filters" } do %>
      <div class="search-input-wrapper">
        <svg class="search-input-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input type="text"
               name="q"
               value="<%= @query %>"
               placeholder="Search projects, files, samples..."
               class="search-input"
               autocomplete="off"
               data-search-filters-target="searchInput"
               data-action="input->search-filters#searchWithDebounce keydown->search-filters#submitOnEnter"
               <%= 'autofocus' if @query.present? %>>
        <% if @query.present? %>
          <%= link_to search_path, class: "search-clear-btn" do %>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          <% end %>
        <% end %>
      </div>

      <!-- Filters Row -->
      <div class="search-filters">
        <!-- Sort By -->
        <div class="filter-group">
          <label class="filter-label">Sort by</label>
          <select name="sort" class="filter-select" data-action="change->search-filters#submit">
            <option value="" <%= 'selected' if @sort.blank? %>>------</option>
            <option value="recent" <%= 'selected' if @sort == 'recent' %>>Recent</option>
            <option value="oldest" <%= 'selected' if @sort == 'oldest' %>>Oldest</option>
            <option value="a-z" <%= 'selected' if @sort == 'a-z' %>>A-Z</option>
            <option value="z-a" <%= 'selected' if @sort == 'z-a' %>>Z-A</option>
          </select>
        </div>

        <!-- Date Range -->
        <div class="filter-group">
          <label class="filter-label">From</label>
          <input type="date" name="date_from" value="<%= @date_from %>" class="filter-date" data-action="change->search-filters#submit">
        </div>

        <div class="filter-group">
          <label class="filter-label">To</label>
          <input type="date" name="date_to" value="<%= @date_to %>" class="filter-date" data-action="change->search-filters#submit">
        </div>

        <!-- BPM with Exact/Range toggle -->
        <div class="filter-group filter-group-bpm">
          <label class="filter-label">BPM</label>
          <div class="bpm-controls">
            <select name="bpm_mode" class="filter-select bpm-mode-select" data-action="change->search-filters#toggleBpmMode change->search-filters#submit" data-search-filters-target="bpmMode">
              <option value="range" <%= 'selected' if @bpm_mode == 'range' %>>Range</option>
              <option value="exact" <%= 'selected' if @bpm_mode == 'exact' %>>Exact</option>
            </select>

            <!-- Exact BPM input -->
            <div class="bpm-exact-input <%= 'hidden' unless @bpm_mode == 'exact' %>" data-search-filters-target="bpmExact">
              <input type="number" name="bpm_exact" value="<%= @bpm_exact %>" class="filter-number" placeholder="80" min="40" max="300" data-action="change->search-filters#submit keydown->search-filters#submitOnEnter" data-search-filters-target="bpmExactInput">
            </div>

            <!-- Range BPM inputs -->
            <div class="bpm-range-inputs <%= 'hidden' if @bpm_mode == 'exact' %>" data-search-filters-target="bpmRange">
              <input type="number" name="bpm_min" value="<%= @bpm_min %>" class="filter-number" placeholder="70" min="40" max="300" data-action="change->search-filters#submit keydown->search-filters#submitOnEnter" data-search-filters-target="bpmMinInput">
              <span class="bpm-separator">-</span>
              <input type="number" name="bpm_max" value="<%= @bpm_max %>" class="filter-number" placeholder="140" min="40" max="300" data-action="change->search-filters#submit keydown->search-filters#submitOnEnter" data-search-filters-target="bpmMaxInput">
            </div>
          </div>
        </div>

        <!-- Musical Key -->
        <div class="filter-group">
          <label class="filter-label">Key</label>
          <select name="key" class="filter-select" data-action="change->search-filters#submit">
            <option value="">Any key</option>
            <optgroup label="Major">
              <option value="C" <%= 'selected' if @key == 'C' %>>C Major</option>
              <option value="C#" <%= 'selected' if @key == 'C#' %>>C# Major</option>
              <option value="D" <%= 'selected' if @key == 'D' %>>D Major</option>
              <option value="Eb" <%= 'selected' if @key == 'Eb' %>>Eb Major</option>
              <option value="E" <%= 'selected' if @key == 'E' %>>E Major</option>
              <option value="F" <%= 'selected' if @key == 'F' %>>F Major</option>
              <option value="F#" <%= 'selected' if @key == 'F#' %>>F# Major</option>
              <option value="G" <%= 'selected' if @key == 'G' %>>G Major</option>
              <option value="Ab" <%= 'selected' if @key == 'Ab' %>>Ab Major</option>
              <option value="A" <%= 'selected' if @key == 'A' %>>A Major</option>
              <option value="Bb" <%= 'selected' if @key == 'Bb' %>>Bb Major</option>
              <option value="B" <%= 'selected' if @key == 'B' %>>B Major</option>
            </optgroup>
            <optgroup label="Minor">
              <option value="Cm" <%= 'selected' if @key == 'Cm' %>>C Minor</option>
              <option value="C#m" <%= 'selected' if @key == 'C#m' %>>C# Minor</option>
              <option value="Dm" <%= 'selected' if @key == 'Dm' %>>D Minor</option>
              <option value="Ebm" <%= 'selected' if @key == 'Ebm' %>>Eb Minor</option>
              <option value="Em" <%= 'selected' if @key == 'Em' %>>E Minor</option>
              <option value="Fm" <%= 'selected' if @key == 'Fm' %>>F Minor</option>
              <option value="F#m" <%= 'selected' if @key == 'F#m' %>>F# Minor</option>
              <option value="Gm" <%= 'selected' if @key == 'Gm' %>>G Minor</option>
              <option value="Abm" <%= 'selected' if @key == 'Abm' %>>Ab Minor</option>
              <option value="Am" <%= 'selected' if @key == 'Am' %>>A Minor</option>
              <option value="Bbm" <%= 'selected' if @key == 'Bbm' %>>Bb Minor</option>
              <option value="Bm" <%= 'selected' if @key == 'Bm' %>>B Minor</option>
            </optgroup>
          </select>
        </div>

        <%= link_to "Clear all", search_path, class: "filter-clear-btn" %>
      </div>
    <% end %>
  </div>

  <!-- Results Section -->
  <div class="search-results-section">
    <% total_results = @projects.count + @files.count %>

    <% if @has_filters %>
      <div class="search-results-header">
        <span class="results-count"><%= total_results %> result<%= total_results == 1 ? '' : 's' %></span>
        <% if @query.present? %>
          <span class="results-query">for "<%= @query %>"</span>
        <% end %>
      </div>

      <% if total_results > 0 %>
        <!-- Projects Results (Library-style grid) -->
        <% if @projects.any? %>
          <div class="results-group">
            <h3 class="results-group-title">Projects (<%= @projects.count %>)</h3>
            <div class="projects-grid">
              <% @projects.each do |project| %>
                <div class="project-card-wrapper">
                  <% if project.folder? %>
                    <%= link_to project_path(project), class: "project-card" do %>
                      <div class="project-icon">
                        <%= image_tag "icons/folder.svg", class: "icon-image" %>
                      </div>
                      <p><%= project.title %></p>
                    <% end %>
                  <% elsif project.file.attached? && project.project_files.any? %>
                    <%= link_to project_path(project), class: "project-card" do %>
                      <div class="project-icon">
                        <%= image_tag project_icon_for(project), class: "icon-image" %>
                      </div>
                      <p><%= project.title %></p>
                    <% end %>
                  <% elsif project.file.attached? %>
                    <% ext = File.extname(project.file.filename.to_s).downcase.delete(".") %>
                    <% if %w[wav mp3 aif aiff flac m4a].include?(ext) %>
                      <div class="project-card"
                           data-audio-url="<%= url_for(project.file) %>"
                           data-audio-title="<%= project.title %>">
                        <div class="project-icon">
                          <%= image_tag project_icon_for(project), class: "icon-image" %>
                        </div>
                        <p><%= project.title %><%= File.extname(project.file.filename.to_s) %></p>
                      </div>
                    <% else %>
                      <div class="project-card">
                        <div class="project-icon">
                          <%= image_tag project_icon_for(project), class: "icon-image" %>
                        </div>
                        <p><%= project.title %><%= File.extname(project.file.filename.to_s) %></p>
                      </div>
                    <% end %>
                  <% else %>
                    <div class="project-card">
                      <div class="project-icon">
                        <%= image_tag project_icon_for(project), class: "icon-image" %>
                      </div>
                      <p><%= project.title %></p>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Files Results (Library-style grid) -->
        <% if @files.any? %>
          <div class="results-group">
            <h3 class="results-group-title">Files (<%= @files.count %>)</h3>
            <div class="projects-grid">
              <% @files.each do |file| %>
                <div class="project-card-wrapper">
                  <% if file.is_directory %>
                    <%= link_to project_path(file.project, folder_id: file.id), class: "project-card" do %>
                      <div class="project-icon">
                        <%= image_tag file_icon_for(file), class: "icon-image" %>
                      </div>
                      <p><%= file.original_filename %></p>
                    <% end %>
                  <% elsif %w[wav mp3 aif aiff flac m4a].include?(file.extension) && file.file.attached? %>
                    <div class="project-card"
                         data-audio-url="<%= url_for(file.file) %>"
                         data-audio-title="<%= file.original_filename %>">
                      <div class="project-icon">
                        <%= image_tag file_icon_for(file), class: "icon-image" %>
                      </div>
                      <p><%= file.original_filename %></p>
                    </div>
                  <% else %>
                    <%= link_to project_path(file.project), class: "project-card" do %>
                      <div class="project-icon">
                        <%= image_tag file_icon_for(file), class: "icon-image" %>
                      </div>
                      <p><%= file.original_filename %></p>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="search-no-results-box">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <p>No results found</p>
          <span>Try adjusting your search or filters</span>
        </div>
      <% end %>
    <% else %>
      <!-- Empty state - no search yet -->
      <div class="search-empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <p>Search your library</p>
        <span>Find projects, samples, and files by name, BPM, key, or date</span>
      </div>
    <% end %>
  </div>
</div>

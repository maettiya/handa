<h1 class="page-title">LIBRARY</h1>

<div class="add-project-btn" id="add-project-btn">
  + Add projects
</div>

<%= form_with model: Project.new, id: "upload-form" do |f| %>
  <%= f.file_field :file, class: "file-input", id: "file-input", accept: ".als,.logicx,.wav,.mp3,.zip" %>

  <div id="file-details" style="display: none;">
    <p id="selected-file-title" style="text-align: center; margin-bottom: 10px;"></p>
    <%= f.text_field :title, placeholder: "Project title", class: "project-title-input", id: "project-title-input" %>
    <%= f.submit "Upload", class: "upload-btn" %>
  </div>
<% end %>

<div class="drop-zone" id="drop-zone">
  <% if current_user.projects.any? %>
    <div class="projects-grid">
      <% current_user.projects.each do |project| %>
        <div class="project-card-wrapper">
          <% if project.folder? %>
            <%# Empty folder - clickable to browse inside %>
            <%= link_to project_path(project), class: "project-card" do %>
              <div class="project-icon">
                <%= image_tag "icons/folder.svg", class: "icon-image" %>
              </div>
              <p><%= project.title %></p>
            <% end %>
          <% elsif project.file.attached? && project.project_files.any? %>
            <%# Project has extracted contents - clickable to browse inside %>
            <%= link_to project_path(project), class: "project-card" do %>
              <div class="project-icon">
                <%= image_tag project_icon_for(project), class: "icon-image" %>
              </div>
              <p><%= project.title %><%= File.extname(project.file.filename.to_s) %></p>
            <% end %>
          <% elsif project.file.attached? %>
            <%# Single file (wav, mp3, etc) - not clickable, nothing to browse %>
            <div class="project-card">
              <div class="project-icon">
                <%= image_tag project_icon_for(project), class: "icon-image" %>
              </div>
              <p><%= project.title %><%= File.extname(project.file.filename.to_s) %></p>
            </div>
          <% else %>
            <%# No file attached - just display %>
            <div class="project-card">
              <div class="project-icon">
                <%= image_tag project_icon_for(project), class: "icon-image" %>
              </div>
              <p><%= project.title %></p>
            </div>
          <% end %>

          <%# Three-dot menu for actions - now on ALL items %>
          <div class="card-menu" data-controller="dropdown">
            <button class="menu-trigger" data-action="click->dropdown#toggle">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <circle cx="3" cy="8" r="1.5"/>
                <circle cx="8" cy="8" r="1.5"/>
                <circle cx="13" cy="8" r="1.5"/>
              </svg>
            </button>
            <div class="menu-dropdown" data-dropdown-target="menu">
              <% if project.file.attached? %>
                <%= link_to "Download", download_project_path(project), class: "menu-item" %>
                <div class="menu-divider"></div>
              <% end %>
              <%= link_to "Delete", project_path(project),
                  data: { turbo_method: :delete, turbo_confirm: "Delete '#{project.title}'? This cannot be undone." },
                  class: "menu-item menu-item-danger" %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <p class="empty-state">Drag & drop files here or use the button above</p>
  <% end %>
</div>

<!-- Right-click Context Menu -->
<div id="context-menu" class="context-menu">
  <button class="context-menu-item" id="context-new-folder">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
      <line x1="12" y1="11" x2="12" y2="17"></line>
      <line x1="9" y1="14" x2="15" y2="14"></line>
    </svg>
    New Folder
  </button>
</div>

<!-- New Folder Modal -->
<div id="folder-modal" class="modal-overlay">
  <div class="modal-content">
    <h3>Create New Folder</h3>
    <%= form_with url: create_folder_projects_path, method: :post, class: "folder-form" do %>
      <input type="text" name="folder_name" placeholder="Folder name" class="folder-name-input" id="folder-name-input" required>
      <div class="modal-actions">
        <button type="button" class="cancel-btn" id="cancel-folder">Cancel</button>
        <button type="submit" class="save-btn">Create</button>
      </div>
    <% end %>
  </div>
</div>

<div class="share-page">
  <div class="share-card">
    <div class="share-icon">
      <%= image_tag asset_icon_for(@asset), class: "icon-image" %>
    </div>

    <h1 class="share-title"><%= @asset.title %></h1>

    <% if @asset.file.attached? %>
      <p class="share-meta"><%= number_to_human_size(@asset.file.byte_size) %></p>
    <% end %>

    <% if @require_password %>
      <div class="share-password-form">
        <p class="share-password-label">This file is password protected</p>

        <% if @password_error %>
          <p class="share-error"><%= @password_error %></p>
        <% end %>

        <%= form_with url: share_link_verify_path(@share_link.token), method: :post, local: true do |f| %>
          <%= f.password_field :password, placeholder: "Enter password", class: "share-password-input" %>
          <%= f.submit "Unlock", class: "share-download-btn" %>
        <% end %>
      </div>
    <% else %>
      <% if @asset.is_directory? || @asset.children.any? %>
        <%# Folder download - use background job (works for all users) %>
        <button class="share-download-btn"
                onclick="document.dispatchEvent(new CustomEvent('handa:start-share-download', { detail: { token: '<%= @share_link.token %>', filename: '<%= j(@asset.title) %>' } }))">
          Download
        </button>
      <% else %>
        <%# Single file - direct download %>
        <%= link_to "Download", share_link_download_path(@share_link.token), class: "share-download-btn" %>
      <% end %>

      <% if user_signed_in? %>
        <%= button_to "Save to Library", share_link_save_path(@share_link.token), method: :post, class: "share-save-btn" %>
      <% else %>
        <p class="share-save-prompt">
          <%= link_to "Sign in", new_user_session_path %> to save to your library
        </p>
      <% end %>
    <% end %>

    <p class="share-footer">
      Shared by @<%= @asset.user.username %> via Handa
    </p>
  </div>
</div>

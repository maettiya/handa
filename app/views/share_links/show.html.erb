<div class="share-page">
  <% if @require_password %>
    <%# Password protected - show unlock form %>
    <div class="share-card">
      <div class="share-icon">
        <%= image_tag asset_icon_for(@asset), class: "icon-image" %>
      </div>

      <h1 class="share-title"><%= @asset.title %></h1>

      <div class="share-password-form">
        <p class="share-password-label">This file is password protected</p>

        <% if @password_error %>
          <p class="share-error"><%= @password_error %></p>
        <% end %>

        <%= form_with url: share_link_verify_path(@share_link.token), method: :post, local: true do |f| %>
          <%= f.password_field :password, placeholder: "Enter password", class: "share-password-input" %>
          <%= f.submit "Unlock", class: "share-download-btn" %>
        <% end %>
      </div>

      <p class="share-footer">
        Shared by @<%= @asset.user.username %> via Handa
      </p>
    </div>

  <% elsif @files.any? || @asset.is_directory? || @asset.children.any? %>
    <%# Folder/project share - show browsable file grid %>
    <div class="share-preview">
      <%# Header with title and actions %>
      <div class="share-preview-header">
        <div class="share-preview-info">
          <div class="share-preview-icon">
            <%= image_tag asset_icon_for(@asset), class: "icon-image" %>
          </div>
          <div class="share-preview-title-wrap">
            <h1 class="share-preview-title"><%= @asset.title %></h1>
            <p class="share-preview-meta">Shared by @<%= @asset.user.username %></p>
          </div>
        </div>
        <div class="share-preview-actions">
          <button class="share-download-btn"
                  onclick="document.dispatchEvent(new CustomEvent('handa:start-share-download', { detail: { token: '<%= @share_link.token %>', filename: '<%= j(@asset.title) %>' } }))">
            Download All
          </button>
          <% if user_signed_in? %>
            <%= button_to "Save to Library", share_link_save_path(@share_link.token), method: :post, class: "share-save-btn" %>
          <% else %>
            <%= link_to "Sign in to Save", new_user_session_path, class: "share-save-btn share-save-btn-secondary" %>
          <% end %>
        </div>
      </div>

      <%# Breadcrumb navigation %>
      <div class="share-breadcrumbs">
        <%= link_to @asset.title, share_link_path(@share_link.token), class: "share-breadcrumb #{'share-breadcrumb-current' unless @current_folder}" %>
        <% if @current_folder %>
          <%# Build breadcrumb path from current folder back to root, skipping the auto-skipped root folder %>
          <% breadcrumb_path = [] %>
          <% folder = @current_folder %>
          <% stop_ids = [@asset.id, @skipped_root_folder&.id].compact %>
          <% while folder && !stop_ids.include?(folder.id) %>
            <% breadcrumb_path.unshift(folder) %>
            <% folder = folder.parent %>
          <% end %>
          <% breadcrumb_path.each_with_index do |crumb, index| %>
            <span class="share-breadcrumb-separator">/</span>
            <% if index == breadcrumb_path.length - 1 %>
              <span class="share-breadcrumb share-breadcrumb-current"><%= crumb.title %></span>
            <% else %>
              <%= link_to crumb.title, share_link_path(@share_link.token, folder_id: crumb.id), class: "share-breadcrumb" %>
            <% end %>
          <% end %>
        <% end %>
      </div>

      <%# File grid %>
      <div class="share-files-grid">
        <% @files.each do |file| %>
          <div class="project-card-wrapper">
            <% if file.is_directory? %>
              <%# Folder - click to navigate %>
              <%= link_to share_link_path(@share_link.token, folder_id: file.id), class: "share-file-card" do %>
                <div class="share-file-icon">
                  <%= image_tag asset_icon_for(file), class: "icon-image" %>
                </div>
                <p class="share-file-name" title="<%= file.original_filename || file.title %>"><%= truncate(file.original_filename || file.title, length: 24) %></p>
              <% end %>
            <% elsif file.file.attached? && %w[wav mp3 aif aiff flac m4a].include?(file.extension) %>
              <%# Audio file - clickable to play %>
              <div class="share-file-card share-file-audio"
                   data-audio-url="<%= url_for(file.file) %>"
                   data-audio-title="<%= file.original_filename || file.title %>">
                <div class="share-file-icon project-icon-playable">
                  <%= image_tag asset_icon_for(file), class: "icon-image" %>
                  <div class="project-icon-play-overlay">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                  </div>
                </div>
                <p class="share-file-name" title="<%= file.original_filename || file.title %>"><%= truncate(file.original_filename || file.title, length: 24) %></p>
              </div>
            <% else %>
              <%# Other file - display with icon %>
              <div class="share-file-card">
                <div class="share-file-icon">
                  <%= image_tag asset_icon_for(file), class: "icon-image" %>
                </div>
                <p class="share-file-name" title="<%= file.original_filename || file.title %>"><%= truncate(file.original_filename || file.title, length: 24) %></p>
              </div>
            <% end %>

            <%# Three-dot menu with Download option %>
            <% if file.is_directory? || file.file.attached? %>
              <div class="card-menu" data-controller="dropdown">
                <button class="menu-trigger" data-action="click->dropdown#toggle">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <circle cx="3" cy="8" r="1.5"/>
                    <circle cx="8" cy="8" r="1.5"/>
                    <circle cx="13" cy="8" r="1.5"/>
                  </svg>
                </button>
                <div class="menu-dropdown" data-dropdown-target="menu">
                  <% if file.is_directory? || file.children.any? %>
                    <button class="menu-item"
                            onclick="document.dispatchEvent(new CustomEvent('handa:start-share-download', { detail: { token: '<%= @share_link.token %>', fileId: '<%= file.id %>', filename: '<%= j(file.original_filename || file.title) %>' } }))">
                      Download
                    </button>
                  <% elsif file.file.attached? %>
                    <%= link_to "Download", share_link_download_file_path(@share_link.token, file.id), class: "menu-item" %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <% if @files.empty? %>
        <p class="share-empty">This folder is empty</p>
      <% end %>
    </div>

  <% else %>
    <%# Single file share - floating card style %>
    <div class="share-card share-card-single">
      <% if @asset.file.attached? && %w[wav mp3 aif aiff flac m4a].include?(@asset.extension) %>
        <%# Audio file - icon with play overlay %>
        <div class="share-icon share-icon-playable"
             data-audio-url="<%= url_for(@asset.file) %>"
             data-audio-title="<%= @asset.title %>">
          <%= image_tag asset_icon_for(@asset), class: "icon-image" %>
          <div class="share-icon-play-overlay">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </div>
        </div>
      <% else %>
        <div class="share-icon">
          <%= image_tag asset_icon_for(@asset), class: "icon-image" %>
        </div>
      <% end %>

      <h1 class="share-title"><%= @asset.title %></h1>

      <% if @asset.file.attached? %>
        <p class="share-meta"><%= number_to_human_size(@asset.file.byte_size) %></p>
      <% end %>

      <div class="share-single-actions">
        <%= link_to "Download", share_link_download_path(@share_link.token), class: "share-download-btn" %>

        <% if user_signed_in? %>
          <%= button_to "Save to Library", share_link_save_path(@share_link.token), method: :post, class: "share-save-btn" %>
        <% else %>
          <%= link_to "Sign in to Save", new_user_session_path, class: "share-save-btn share-save-btn-secondary" %>
        <% end %>
      </div>

      <p class="share-footer">
        Shared by @<%= @asset.user.username %> via Handa
      </p>
    </div>
  <% end %>
</div>
